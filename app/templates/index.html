<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ü–æ—Å—Ç—ã Telegram-–∫–∞–Ω–∞–ª–∞</title>
    <style>
        .media-preview { max-width: 120px; max-height: 120px; display: inline-block; margin: 2px;}
        .posts-flex { display: flex; flex-wrap: wrap; gap: 18px; }
        .post-block {
            border: 1px solid #ccc;
            border-radius: 10px;
            margin: 0;
            padding: 12px;
            background: #fff;
            box-shadow: 0 2px 8px #0001;
            min-width: 320px;
            max-width: 340px;
            flex: 1 1 320px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            cursor: grab;
            opacity: 1;
            transition: box-shadow 0.2s, opacity 0.2s;
        }
        #sent-posts-list .post-block {
            background: #f8f8f8;
            cursor: default;
            border-color: #ddd;
        }
        .post-block.dragging {
            opacity: 0.6;
            box-shadow: 0 4px 16px #2196f355;
        }
        .post-block.drag-over {
            border: 2px dashed #2196f3;
        }
        .controls { margin-bottom: 5px; }
        .post-text { background:#f9f9f9; padding:5px; border-radius:4px; white-space:pre-line; }
        .calendar-container { display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: 20px; }
        .mini-calendar { border: 1px solid #ddd; border-radius: 6px; padding: 6px; min-width: 240px; background: #fafbfc;}
        .mini-calendar-title { font-weight: bold; text-align: center; margin-bottom: 4px; }
        .mini-calendar-table { border-collapse: collapse; width: 100%; }
        .mini-calendar-table th, .mini-calendar-table td { width: 14.28%; height: 28px; text-align: center; font-size: 13px; border: none; position: relative; }
        .mini-calendar-today { border: 2px solid #2196f3; border-radius: 50%; }
        .mini-calendar-dot { width: 6px; height: 6px; background: #2196f3; border-radius: 50%; position: absolute; left: 50%; bottom: 2px; transform: translateX(-50%); }
        .edit-btn { margin-left: 5px; }
        .edit-form { margin-top: 5px; }
        .edit-actions { margin-top: 5px; }
        .redistribute-warning {
            color: #fff;
            background: #f44336;
            padding: 6px 12px;
            border-radius: 6px;
            display: inline-block;
            margin-bottom: 10px;
            font-weight: bold;
            font-size: 15px;
        }
        .media-block { display: none; }
        .media-block.visible { display: block; }
        .mobile-move-btns { display: none; }
        @media (max-width: 900px) {
            .calendar-container { flex-direction: column; }
            .posts-flex { flex-direction: column; }
            .post-block { min-width: 98vw; max-width: 99vw; }
            .mobile-move-btns { display: inline-block; }
        }
    </style>
</head>
<body>
    <h1>–ü–æ—Å—Ç—ã</h1>
    <a href="{{ url_for('add_post') }}">–î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å—Ç</a>
    <hr>
    <h2>–ö–∞–ª–µ–Ω–¥–∞—Ä—å –ø—É–±–ª–∏–∫–∞—Ü–∏–π</h2>
    <div id="calendar-container" class="calendar-container"></div>
    <hr>
    <h2>–†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ—Å—Ç—ã –ø–æ –¥–∞—Ç–∞–º</h2>
    <div id="redistribute-warning" class="redistribute-warning" style="display:none;">
        –í–Ω–∏–º–∞–Ω–∏–µ: –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞ –ø–æ—Å—Ç–æ–≤ –Ω–µ –±—ã–ª–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ <b>–¥–∏—Å—Ç—Ä–∏–±—É—Ü–∏—è</b>!<br>
        –ù–∞–∂–º–∏—Ç–µ "–†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å", —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞—Ç—ã –ø—É–±–ª–∏–∫–∞—Ü–∏–π.
    </div>
    <form id="distribute-form" method="post" action="{{ url_for('distribute_posts') }}">
        <label>–ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞:
            <input type="date" name="start_date" required value="{{ start_date }}">
        </label>
        <label>–ö–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞:
            <input type="date" name="end_date" required value="{{ end_date }}">
        </label>
        <button type="submit">–†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å</button>
    </form>
    <div style="margin: 10px 0;">
        <label>
            <input type="checkbox" id="toggle-media" checked>
            –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –º–µ–¥–∏–∞ –¥–ª—è –≤—Å–µ—Ö –ø–æ—Å—Ç–æ–≤ (–º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω–æ)
        </label>
    </div>
    <hr>
    <div id="posts-list" class="posts-flex">
    {% for post in posts if post.status != 'sent' %}
    <div class="post-block" data-post-id="{{ post.id }}" draggable="true">
        <div class="controls">
            <form class="delete-form" method="post" action="{{ url_for('delete_post', post_id=post.id) }}" style="display:inline;">
                <button type="submit" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
            </form>
            <button class="edit-btn" data-id="{{ post.id }}">‚úèÔ∏è</button>
            <span class="mobile-move-btns">
                <button class="move-up-btn" data-id="{{ post.id }}" title="–í–≤–µ—Ä—Ö">&#8593;</button>
                <button class="move-down-btn" data-id="{{ post.id }}" title="–í–Ω–∏–∑">&#8595;</button>
            </span>
        </div>
        <b class="post-date">{{ post.scheduled_at or '–ë–µ–∑ –¥–∞—Ç—ã' }}</b><br>
        <div>
            <span>–ü–∞–ø–∫–∞: {{ post.folder_path }}</span>
        </div>
        <div>
            <b>–¢–µ–∫—Å—Ç:</b>
            <div class="post-text" data-field="text">{{ post.text|safe }}</div>
        </div>
        <div class="media-block">
            <b>–ú–µ–¥–∏–∞:</b>
            {% for mtype, fname in post.media_files %}
                {% if mtype == 'image' %}
                    <img src="{{ url_for('media', post_id=post.id, filename=fname) }}" class="media-preview" alt="img">
                {% elif mtype == 'video' %}
                    <video src="{{ url_for('media', post_id=post.id, filename=fname) }}" class="media-preview" controls></video>
                {% else %}
                    <a href="{{ url_for('media', post_id=post.id, filename=fname) }}" target="_blank">{{ fname }}</a>
                {% endif %}
            {% else %}
                <span>–ù–µ—Ç –º–µ–¥–∏–∞</span>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <div>–ü–æ—Å—Ç–æ–≤ –Ω–µ—Ç</div>
    {% endfor %}
    </div>

    <hr>
    <h2>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø–æ—Å—Ç—ã</h2>
    <div id="sent-posts-list" class="posts-flex">
    {% for post in posts if post.status == 'sent' %}
    <div class="post-block" data-post-id="{{ post.id }}">
        <b class="post-date">{{ post.scheduled_at or '–ë–µ–∑ –¥–∞—Ç—ã' }}</b><br>
        <div>
            <span>–ü–∞–ø–∫–∞: {{ post.folder_path }}</span>
        </div>
        <div>
            <b>–¢–µ–∫—Å—Ç:</b>
            <div class="post-text" data-field="text">{{ post.text|safe }}</div>
        </div>
        <div class="media-block visible">
            <b>–ú–µ–¥–∏–∞:</b>
            {% for mtype, fname in post.media_files %}
                {% if mtype == 'image' %}
                    <img src="{{ url_for('media', post_id=post.id, filename=fname) }}" class="media-preview" alt="img">
                {% elif mtype == 'video' %}
                    <video src="{{ url_for('media', post_id=post.id, filename=fname) }}" class="media-preview" controls></video>
                {% else %}
                    <a href="{{ url_for('media', post_id=post.id, filename=fname) }}" target="_blank">{{ fname }}</a>
                {% endif %}
            {% else %}
                <span>–ù–µ—Ç –º–µ–¥–∏–∞</span>
            {% endfor %}
        </div>
        <div>
            <b>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ:</b> {{ post.sent_at or '‚Äî' }}
        </div>
    </div>
    {% else %}
    <div>–ù–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤</div>
    {% endfor %}
    </div>
<script>
    // Drag-and-drop –∫–∞—Ä—Ç–æ—á–µ–∫ –ø–æ—Å—Ç–æ–≤
    let dragSrcEl = null;
    let postsList = document.getElementById('posts-list');

    function handleDragStart(e) {
        dragSrcEl = this;
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
    }
    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        return false;
    }
    function handleDragEnter(e) {
        if (this !== dragSrcEl) this.classList.add('drag-over');
    }
    function handleDragLeave(e) {
        this.classList.remove('drag-over');
    }
    function handleDrop(e) {
        e.stopPropagation();
        if (dragSrcEl !== this) {
            // –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å DOM
            let children = Array.from(postsList.children);
            let srcIdx = children.indexOf(dragSrcEl);
            let tgtIdx = children.indexOf(this);
            if (srcIdx < tgtIdx) {
                postsList.insertBefore(dragSrcEl, this.nextSibling);
            } else {
                postsList.insertBefore(dragSrcEl, this);
            }
            // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–æ–≤—ã–π –ø–æ—Ä—è–¥–æ–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
            saveNewOrder();
        }
        this.classList.remove('drag-over');
        dragSrcEl.classList.remove('dragging');
        return false;
    }
    function handleDragEnd(e) {
        this.classList.remove('dragging');
        document.querySelectorAll('.post-block').forEach(function (item) {
            item.classList.remove('drag-over');
        });
    }
    function saveNewOrder() {
        let ids = Array.from(postsList.children)
            .filter(el => el.hasAttribute('data-post-id'))
            .map(el => el.getAttribute('data-post-id'));
        fetch('/reorder_posts', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({order: ids})
        }).then(resp => resp.json()).then(data => {
            if (!data.success) {
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞!');
            } else {
                setRedistributeWarning(true);
            }
        });
    }

    // –ü–æ–º–µ—Ç–∫–∞ –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥–∏—Å—Ç—Ä–∏–±—É—Ü–∏–∏
    function setRedistributeWarning(flag) {
        localStorage.setItem('need_redistribute', flag ? '1' : '');
        document.getElementById('redistribute-warning').style.display = flag ? '' : 'none';
    }
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–º–µ—Ç–∫—É –µ—Å–ª–∏ –Ω–∞–¥–æ
    if (localStorage.getItem('need_redistribute') === '1') {
        document.getElementById('redistribute-warning').style.display = '';
    }
    // –ü–æ—Å–ª–µ –¥–∏—Å—Ç—Ä–∏–±—É—Ü–∏–∏ —É–±–∏—Ä–∞–µ–º –ø–æ–º–µ—Ç–∫—É
    document.getElementById('distribute-form').addEventListener('submit', function() {
        setRedistributeWarning(false);
    });
    // Drag-and-drop –¥–ª—è desktop, –∫–Ω–æ–ø–∫–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
    function isMobile() {
        return window.matchMedia("(max-width: 900px)").matches;
    }
    document.querySelectorAll('.post-block').forEach(function(item) {
        if (!isMobile()) {
            item.addEventListener('dragstart', handleDragStart, false);
            item.addEventListener('dragenter', handleDragEnter, false);
            item.addEventListener('dragover', handleDragOver, false);
            item.addEventListener('dragleave', handleDragLeave, false);
            item.addEventListener('drop', handleDrop, false);
            item.addEventListener('dragend', handleDragEnd, false);
        }
    });

    // –ú–æ–±–∏–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
    document.querySelectorAll('.move-up-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const block = this.closest('.post-block');
            if (block.previousElementSibling) {
                block.parentNode.insertBefore(block, block.previousElementSibling);
                saveNewOrder();
            }
        });
    });
    document.querySelectorAll('.move-down-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const block = this.closest('.post-block');
            if (block.nextElementSibling) {
                block.parentNode.insertBefore(block.nextElementSibling, block);
                saveNewOrder();
            }
        });
    });

    // AJAX-—É–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–∞ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
    document.querySelectorAll('.delete-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç?')) return;
            fetch(this.action, {method: 'POST'})
                .then(resp => resp.json())
                .then(data => {
                    if (data.success) {
                        this.closest('.post-block').remove();
                        setRedistributeWarning(true);
                    } else {
                        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è!');
                    }
                });
        });
    });

    // –ò–Ω–ª–∞–π–Ω-—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å—Ç–∞
    document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const postBlock = this.closest('.post-block');
            const postId = this.dataset.id;
            if (postBlock.querySelector('.edit-form')) return; // –£–∂–µ –æ—Ç–∫—Ä—ã—Ç–∞ —Ñ–æ—Ä–º–∞

            const textDiv = postBlock.querySelector('.post-text');
            const dateDiv = postBlock.querySelector('.post-date');
            const oldText = textDiv.innerText;
            const oldDate = dateDiv.innerText !== '–ë–µ–∑ –¥–∞—Ç—ã' ? dateDiv.innerText : '';
            const mediaBlock = postBlock.querySelector('.media-block');

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–¥–∏–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–≥–æ –ø–æ—Å—Ç–∞
            if (mediaBlock) mediaBlock.classList.add('visible');

            // –°–æ–∑–¥–∞—ë–º —Ñ–æ—Ä–º—É
            const form = document.createElement('form');
            form.className = 'edit-form';
            form.innerHTML = `
                <textarea name="text" rows="4" style="width:98%">${oldText}</textarea><br>
                <label>–î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:
                    <input type="datetime-local" name="scheduled_at" value="${oldDate ? oldDate.replace(' ', 'T') : ''}">
                </label>
                <div class="edit-actions">
                    <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button type="button" class="cancel-edit">–û—Ç–º–µ–Ω–∞</button>
                </div>
            `;
            textDiv.style.display = 'none';
            dateDiv.style.display = 'none';
            textDiv.parentNode.appendChild(form);

            form.querySelector('.cancel-edit').onclick = function() {
                form.remove();
                textDiv.style.display = '';
                dateDiv.style.display = '';
                if (mediaBlock && !document.getElementById('toggle-media').checked) mediaBlock.classList.remove('visible');
            };

            form.onsubmit = function(e) {
                e.preventDefault();
                fetch(`/edit/${postId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        text: form.text.value,
                        scheduled_at: form.scheduled_at.value
                    })
                })
                .then(resp => resp.json())
                .then(data => {
                    if (data.success) {
                        textDiv.innerText = form.text.value;
                        dateDiv.innerText = form.scheduled_at.value ? form.scheduled_at.value.replace('T', ' ') : '–ë–µ–∑ –¥–∞—Ç—ã';
                        form.remove();
                        textDiv.style.display = '';
                        dateDiv.style.display = '';
                        setRedistributeWarning(true);
                        if (mediaBlock && !document.getElementById('toggle-media').checked) mediaBlock.classList.remove('visible');
                    } else {
                        alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!');
                    }
                });
            };
        });
    });

    // –¢–æ–≥–≥–ª –ø–æ–∫–∞–∑–∞ –º–µ–¥–∏–∞
    function updateMediaBlocks() {
        const checked = document.getElementById('toggle-media').checked;
        document.querySelectorAll('.media-block').forEach(mb => {
            if (checked) mb.classList.add('visible');
            else mb.classList.remove('visible');
        });
    }
    document.getElementById('toggle-media').addEventListener('change', updateMediaBlocks);
    updateMediaBlocks();

    // –ö–∞–ª–µ–Ω–¥–∞—Ä—å: –¥–æ 18 –º–µ—Å—è—Ü–µ–≤ –≤ —Å—Ç—Ä–æ–∫—É, –º–∏–Ω–∏-–∫–∞–ª–µ–Ω–¥–∞—Ä–∏
    const posts = [
        {% for post in posts if post.scheduled_at and post.status != 'sent' %}
            {date: "{{ post.scheduled_at[:10] }}"},
        {% endfor %}
    ];
    function getMonthKey(d) {
        return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2, '0');
    }
    function getMonthName(d) {
        return d.toLocaleString('ru-RU', {month:'long', year:'numeric'});
    }
    function getDatesRange(posts) {
        if (posts.length === 0) return [];
        let dates = posts.map(p => p.date);
        dates.sort();
        let start = new Date(dates[0]);
        let end = new Date(dates[dates.length-1]);
        let days = [];
        for(let d = new Date(start); d <= end; d.setDate(d.getDate()+1)) {
            days.push(new Date(d));
        }
        return days;
    }
    function formatDate(d) {
    // –ü–æ–ª—É—á–∞–µ–º YYYY-MM-DD –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
        return d.getFullYear() + '-' +
        String(d.getMonth() + 1).padStart(2, '0') + '-' +
        String(d.getDate()).padStart(2, '0');
    }   
    function isToday(d) {
        let now = new Date();
        return d.getFullYear() === now.getFullYear() && d.getMonth() === now.getMonth() && d.getDate() === now.getDate();
    }
    function buildMiniCalendar(month, year, postDates) {
        // –ù–∞–π—Ç–∏ –ø–µ—Ä–≤—ã–π –¥–µ–Ω—å –º–µ—Å—è—Ü–∞
        let firstDay = new Date(year, month, 1);
        let lastDay = new Date(year, month + 1, 0);
        let weeks = [];
        let week = [];
        // –ü—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –¥–æ –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è –Ω–µ–¥–µ–ª–∏ (–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫)
        let empty = firstDay.getDay();
        if (empty === 0) empty = 7; // –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ - 7-–π –¥–µ–Ω—å
        empty = empty - 1; // –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ - 1-–π –¥–µ–Ω—å
        for(let i=0;i<empty;i++) week.push('');
        for(let d=1; d<=lastDay.getDate(); d++) {
            let dateObj = new Date(year, month, d);
            week.push(dateObj);
            if (week.length === 7) {
                weeks.push(week);
                week = [];
            }
        }
        if (week.length > 0) {
            while (week.length < 7) week.push('');
            weeks.push(week);
        }
        // –†–µ–Ω–¥–µ—Ä
        let html = `<div class="mini-calendar">
            <div class="mini-calendar-title">${firstDay.toLocaleString('ru-RU', {month:'long', year:'numeric'})}</div>
            <table class="mini-calendar-table">
                <tr>
                    <th>–ü–Ω</th><th>–í—Ç</th><th>–°—Ä</th><th>–ß—Ç</th><th>–ü—Ç</th><th>–°–±</th><th>–í—Å</th>
                </tr>`;
        for(let w of weeks) {
            html += '<tr>';
            for(let cell of w) {
                if (cell === '') {
                    html += '<td></td>';
                } else {
                    let hasPost = postDates.includes(formatDate(cell));
                    let today = isToday(cell);
                    html += `<td${today ? ' class="mini-calendar-today"' : ''}>${cell.getDate()}`;
                    if (hasPost) html += `<div class="mini-calendar-dot"></div>`;
                    html += `</td>`;
                }
            }
            html += '</tr>';
        }
        html += '</table></div>';
        return html;
    }
    function renderCalendar() {
        const days = getDatesRange(posts);
        if (days.length === 0) return;
        const postDates = posts.map(p => p.date);
        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –º–µ—Å—è—Ü–∞–º
        let months = {};
        days.forEach(d => {
            let key = getMonthKey(d);
            if (!months[key]) months[key] = [];
            months[key].push(d);
        });
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–ª—é—á–∏ –º–µ—Å—è—Ü–µ–≤
        let monthKeys = Object.keys(months).sort();
        // –û–≥—Ä–∞–Ω–∏—á–∏–º –¥–æ 18 –º–µ—Å—è—Ü–µ–≤ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 18)
        if (monthKeys.length > 18) monthKeys = monthKeys.slice(-18);
        const cal = document.getElementById('calendar-container');
        cal.innerHTML = '';
        monthKeys.forEach(key => {
            let [year, month] = key.split('-').map(Number);
            let html = buildMiniCalendar(month-1, year, postDates);
            cal.insertAdjacentHTML('beforeend', html);
        });
    }
    renderCalendar();
</script>
</body>
</html>
